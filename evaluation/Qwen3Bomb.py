import time

from llama_cpp import Llama

# Path to your downloaded GGUF model
model_path = "./models/qwen3-235/Qwen3-235B-A22B-Q4_K_M.gguf"

# Init Llama with GGUF model
llm = Llama(
    model_path=model_path,
    n_gpu_layers=60,  # Adjust for your GPU VRAM
    n_ctx=1024,
    use_mlock=False,
    verbose=False,
    enable_thinking=True,
)

# prompt = (
#     "你是一位推理專家。\n"
#     "根據下列論述、真實證據與其標記為 <SUPPORTS / REFUTES / NOT ENOUGH INFO> 的結果，"
#     "請你評估：在僅給予部分證據的情況下，為何會導致不同的標記判斷。\n\n"
#     "請注意：真實標記的成立，**是建立在所有真實證據**都被給予的情況下；"
#     "若僅提供部分證據，可能無法推導出相同結論，甚至會因資訊不足而導致 NOT ENOUGH INFO。\n"
#     "請根據僅給予的證據內容進行推理，不可依賴真實標記或常識進行猜測。\n\n"
#     #"請引用證據來源（例如：[1]、[2]），並清楚指出哪些資訊足夠、哪些資訊缺失。\n\n"
#     "請在理由中明確引用相關證據來源（例如：[1]、[2]），說明這些證據中有哪些資訊足以推論、或有哪些資訊尚未涵蓋導致資訊不足。\n\n"
#     "論述：一行出家衆出家前的名字爲張遂。\n\n"
#     # "真實證據：\n"
#     # "一行: 一行禪師,俗名張遂,法號敬賢,號大慧禪師,也稱爲沙門一行,一行阿闍梨,唐人還呼爲一公,魏州昌樂(今河南省濮陽市南樂縣)人,唐朝比丘,天文學家,曆法學家,數學家,風水學家.魏州 魏州 河南省 河南省 濮陽市 濮陽市 南樂縣 南樂縣 唐朝 唐朝 比丘 比丘 天文學家 天文學家 曆法 曆法 數學 數學 風水 風水\n"
#     # "比丘: 佛教受具足戒之後的男性出家衆,稱爲比丘."
#     "真實標記：SUPPORTS\n"
#     "標記理由: 一行禪師的俗名被明確提及爲「張遂」。此外，「比丘」是指佛教中受具足戒的男性出家衆。因此，論述中「一行出家衆出家前的名字爲張遂」與提供的證據完全一致。\n\n"
#     "給予以下證據：\n"
#     "[1] 一行: 一行禪師,俗名張遂,法號敬賢,號大慧禪師,也稱爲沙門一行,一行阿闍梨,唐人還呼爲一公,魏州昌樂(今河南省濮陽市南樂縣)人,唐朝比丘,天文學家,曆法學家,數學家,風水學家.魏州 魏州 河南省 河南省 濮陽市 濮陽市 南樂縣 南樂縣 唐朝 唐朝 比丘 比丘 天文學家 天文學家 曆法 曆法 數學 數學 風水 風水.\n"
#     "[2] 比丘: 佛教受具足戒之後的男性出家衆,稱爲比丘.\n"
#     "在使用這些證據的情況下，應當標記為：SUPPORTS\n"
#     "請用以下格式回答：\n"
#     "reason: <你的理由>\n"
# )
# prompt = (
#     "你是一位推理專家。\n"
#     "請根據下列論述與標記結果，分析為什麼在只給予部分證據的情況下，會無法得出原本的標記判斷。\n\n"
#     "請注意：原本的標記結果（SUPPORTS / REFUTES / NOT ENOUGH INFO）是建立在**完整證據**的前提下。\n"
#     "當缺少關鍵證據時，可能會導致推論失敗或資訊不足。\n"
#     "請你從『給予的證據』與『缺少的證據』兩者進行比較，找出推論上的落差與原因。\n\n"
#     "請引用證據來源（例如：[1]、[2]），並清楚指出哪些資訊足夠、哪些資訊缺失。\n\n"
#     "論述：一行出家衆出家前的名字爲張遂。\n"
#     "原始標記：SUPPORTS\n"
#     "給予的證據：<只有這些證據時可見的內容>\n"
#     "[1] 比丘: 佛教受具足戒之後的男性出家衆,稱爲比丘.\n"
#     "[2] 一行: 一行禪師,俗名張遂,法號敬賢,號大慧禪師,也稱爲沙門一行,一行阿闍梨,唐人還呼爲一公,魏州昌樂(今河南省濮陽市南樂縣)人,唐朝比丘,天文學家,曆法學家,數學家,風水學家.魏州 魏州 河南省 河南省 濮陽市 濮陽市 南樂縣 南樂縣 唐朝 唐朝 比丘 比丘 天文學家 天文學家 曆法 曆法 數學 數學 風水 風水.\n"
#     "缺少的證據：<在原始推論中出現但此處未提供的證據>\n"
#      #"比丘: 佛教受具足戒之後的男性出家衆,稱爲比丘.\n"
#      #"一行: 一行禪師,俗名張遂,法號敬賢,號大慧禪師,也稱爲沙門一行,一行阿闍梨,唐人還呼爲一公,魏州昌樂(今河南省濮陽市南樂縣)人,唐朝比丘,天文學家,曆法學家,數學家,風水學家.魏州 魏州 河南省 河南省 濮陽市 濮陽市 南樂縣 南樂縣 唐朝 唐朝 比丘 比丘 天文學家 天文學家 曆法 曆法 數學 數學 風水 風水.\n"
#      "在使用給予的證據的情況下，應當標記為：SUPPORTS\n"
#      "請用請體中文及以下格式回答：\n"
#      "reason: <你的理由>\n"
# )
# prompt = (
#     "你是一位推理專家。\n"
#     "根據下列論述、完整證據與其標記為 <支持 / 反對 > 的結果，請用繁體中文整合所有證據進行合理推理，並說明為何這些證據共同導致該標記。\n"
#     "請避免只使用部分證據，也不要省略推論鏈中的關鍵步驟。\n"
#     "論述：一行出家衆出家前的名字爲張遂。\n"
#     "標記：支持\n"
#     "完整證據：\n"
#     "一行: 一行禪師,俗名張遂,法號敬賢,號大慧禪師,也稱爲沙門一行,一行阿闍梨,唐人還呼爲一公,魏州昌樂(今河南省濮陽市南樂縣)人,唐朝比丘,天文學家,曆法學家,數學家,風水學家.魏州 魏州 河南省 河南省 濮陽市 濮陽市 南樂縣 南樂縣 唐朝 唐朝 比丘 比丘 天文學家 天文學家 曆法 曆法 數學 數學 風水 風水.\n"
#     "比丘: 佛教受具足戒之後的男性出家衆,稱爲比丘.\n"
#     "請用以下格式回答：\n"
#     "理由: <整合所有證據後，你的詳細推理過程>\n"
# )
prompt = (
    "你是一位推理專家。\n"
    "根據下列論述、完整證據與其標記為 <支持 / 反對 > 的結果，請用繁體中文整合所有證據進行合理推理，並說明為何這些證據共同導致該標記。\n"
    "請避免只使用部分證據，也不要省略推論鏈中的關鍵步驟。\n"
    "論述：最流行的《 毛主席語錄 》 是使用波長大約爲630到750nm的人類肉眼可見的電磁波色作爲封面，因此又稱小紅書。\n"
    "標記：支持\n"
    "完整證據：\n"
    '毛主席語錄: < 毛主席語錄 >(又稱 < 毛澤東語錄 >,簡稱 < 毛語錄 >)是前中國共產黨中央委員會主席毛澤東著作中一些語句的選編本,因爲最流行的版本用紅色封面包裝,又是中國共產黨領袖的經典言論,所以文化大革命中被普遍稱爲 " 紅寶書 ".毛澤東 毛澤東 中國共產黨中央委員會主席 中國共產黨中央委員會主席 紅色 紅色 中國共產黨 中國共產黨 文化大革命 文化大革命 紅寶書 紅寶書\n'
    '紅寶書: " 紅寶書 " 或 " 小紅書 " 是文化大革命中對包括 < 毛主席語錄 > 在內的毛澤東文學作品及其在各地發展的一系列合訂本(如 " 三合一 ")等袖珍,簡易的毛澤東著作選編本的稱呼.毛主席語錄 毛主席語錄 三合一 三合一\n'
    "紅色: 紅色,又稱赤色,是以通過能量來激發觀察者的可見光譜中長波末端的顏色,波長大約爲630到750納米,類似於新鮮血液的顏色,是三原色和心理原色之一.\n"
    "請用以下格式回答：\n"
    "理由: <整合所有證據後，你的推理過程>\n"
)
# prompt = "Give me a complete introduction to large language models."

start_time = time.time()
output = llm(
    prompt,
    max_tokens=512,
    stop=["</s>"],
    # temperature=0.7,
    # top_p=0.8,
    # top_k=20,
    # min_p=0,
    # presence_penalty=1.5,
    temperature=0.6,  # thinking recommendation
    top_p=0.95,
    top_k=20,
    min_p=0,
    presence_penalty=1.7,
)
end_time = time.time()
# print(output)
print("Generated output:", output["choices"][0]["text"])
print(f"Inference time: {end_time - start_time:.2f} seconds")
